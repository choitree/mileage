# 트리플여행자 클럽 마일리지 서비스

## SPEC
* Spring Boot 2.7.1
* Java 11
* QueryDSL 1.0.10
* MySQL 8.0.29
* JPA

## 요구사항 
### 리뷰 작성을 할 경우, 리뷰 작성 이벤트가 POST / events 로 이루어지고, 리뷰가 저장된다.

```
{
"type": "REVIEW",
"action": "ADD", /* "MOD", "DELETE" */
"reviewId": "240a0658-dc5f-4878-9381-ebb7b2667772",
"content": "좋아요!",
"attachedPhotoIds": ["e4d1a64e-a531-46de-88d0-ff0ed70c0bb8", "afb0cef2-
851d-4a50-bb07-9cc15cbdc332"],
"userId": "3ede0ef2-92b7-4817-a5f3-0c575361f745",
"placeId": "2e4baf1c-5acb-4efb-a1af-eddada31b00f"
}
```
* type: 미리 정의된 string 타입으로, 리뷰 이벤트의 경우 "REVIEW"입니다. 확장성을 위해서 enum을 만들어서 사용했습니다.
* action: 리뷰 생성 이벤트의 경우 "ADD" , 수정 이벤트는 "MOD" , 삭제 이벤트는 "DELETE" 값을 가지고 있습니다.
* reviewId: UUID 포맷의 review id입니다. 어떤 리뷰에 대한 이벤트인지 가리키는 값입니다.
* content: 리뷰의 내용입니다.
* attachedPhotoIds: 리뷰에 첨부된 이미지들의 id 배열입니다. 
* userId: 리뷰의 작성자 id입니다.
* placeId: 리뷰가 작성된 장소의 id입니다. 

### 포인트 조회 API

#### 1. 유저의 포인트 조회 API (/user/point?userId={userId})
```
response
{
    "point": 0
}
```
* userId : 유저의 아이디입니다.
* point : 해당 유저의 현재 포인트입니다. 초기값과 리뷰의 생성, 수정, 삭제로 발생한 포인트가 반영되어 확인 가능합니다.

#### 2. 유저의 포인트와 포인트로그 조회 API (/user/pointLog?userId={userId})
```
response
{
    "point": 2,
    "pointLogResponseDTOS": [
        {
            "userId": "3ede0ef2-92b7-4817-a5f3-0c575361f745",
            "reviewId": "240a0658-dc5f-4878-9381-ebb7b2667772",
            "eventType": "REVIEW",
            "point": 3,
            "info": "리뷰생성 장소최초리뷰1점 사진1점 내용1점",
            "createdAt": "2022-07-03 14:59:14"
        },
        {
            "userId": "3ede0ef2-92b7-4817-a5f3-0c575361f745",
            "reviewId": "240a0658-dc5f-4878-9381-ebb7b2667772",
            "eventType": "REVIEW",
            "point": -1,
            "info": "리뷰수정 사진삭제차감1점",
            "createdAt": "2022-07-03 14:59:21"
        }
    ]
}
```
* userId : 유저의 아이디입니다.
* point : 해당 유저의 현재 포인트입니다. 초기값과 리뷰의 생성, 수정, 삭제로 발생한 포인트가 반영되어 확인 가능합니다.
* pointLogResponseDTOs : 포인트 로그들이 담긴 전체 DTO입니다.
* userId : 해당 유저의 아이디를 다시 받아줍니다.
* reviewId : 포인트과 관련된 리뷰 아이디입니다.
* eventType : 포인트와 관련된 이벤트입니다. 확장성을 위해 추가하였습니다.
* point : 해당 리뷰로 받게되는 포인트입니다. 만약 포인트가 차감되는 행동((ex)리뷰 수정 시, 글 또는 사진 삭제 또는 리뷰 삭제 등)의 경우, 음수로 확인할 수 있습니다.
* info : 해당 리뷰로 어떻게 점수가 정산되었는지 간략하게 확인할 수 있는 정보입니다.
* createdAt : 해당 리뷰의 행위를 한 시간입니다.
---

### 1. 리뷰 작성

* 해당 액션이 ADD인지 검증합니다.
* 리뷰에 해당하는 유저가 존재하는지 확인합니다.
* 리뷰에 해당하는 장소가 존재하는지 확인합니다.
* 해당 이벤트가 리뷰인지에 대해서 검증합니다.
* 글 작성한 경우 1점 포인트를 받습니다.
* 사진 작성한 경우 1점 포인트를 받습니다.
* 글 또는 사진 중 1가지만 작성하더라도 저장이 가능하며, 둘 다 없는 경우에는 예외가 발생합니다.
* 해당 장소에 첫 번째로 작성한 리뷰의 경우, 1점 포인트를 받습니다. (저장 당시 시점에 장소에 해당하는 리뷰의 개수가 0개인 경우에 지급)
* 리뷰 작성 시, 리뷰에 해당하는 사진들은 photo 테이블에 별도 저장됩니다.
* 리뷰 작성 시, 포인트 지급에 대한 로그 테이블에 정보가 저장됩니다.
* 포인트 지급 테이블의 경우, 포인트 지급 시기와 지급된 이유, 지급된 포인트를 간단하게 확인할 수 있습니다.
* 리뷰 작성 시, 유저의 포인트 필드에도 포인트가 반영되서 업데이트됩니다.


### 2. 리뷰 수정

* 리뷰 수정 시, 해당 액션이 MOD인지 검증합니다.
* 리뷰 수정하려는 리뷰 아이디에 해당하는 리뷰가 존재하는지 검증합니다.
* 리뷰 수정 전에 글의 여부와 수정 후 글의 여부를 비교해서 점수를 지급하거나 차감합니다.
* 리뷰 수정 전의 사진의 존재 여부와 수정 후 사진의 존재 여부를 비교해서 점수를 지급하거나 차감합니다.
* 리뷰를 수정하면서, 글과 사진을 모두 입력하지 않은 상태로 저장하려는 경우 예외가 발생합니다.
* 리뷰 수정 전의 리뷰에 해당하는 모든 사진을 삭제하고, 수정 후 리뷰에 해당하는 모든 사진을 저장합니다.
* 리뷰 수정 시, 리뷰 수정으로 인해 발생/차감된 포인트를 포인트 로그 테이블에 저장합니다.(차감된 경우 음수로 저장합니다.)
* 포인트 로그 테이블의 경우, 포인트 지급 시기와 지급된 이유, 지급된 포인트를 간단하게 확인할 수 있습니다.
* 리뷰 수정 시, 유저의 포인트 필드에도 변경된 포인트가 반영되서 업데이트됩니다.

### 3. 리뷰 삭제

* 리뷰 삭제 시, 해당 액션이 DELETE인지 검증합니다.
* 삭제하려는 리뷰 아이디에 해당하는 리뷰가 존재하는지 검증합니다.
* 해당 리뷰에 해당하는 모든 사진을 삭제합니다.
* 해당 리뷰로 발생한 포인트를 계산해서 모두 회수하고, 유저 테이블에 저장합니다.
* 포인트 로그 테이블 내 외래키인 리뷰아이디를 모두 null로 변경합니다. (유저가 리뷰 지급에 대한 사실 확인 시 파악하기 위함입니다.)
* 리뷰를 삭제합니다.

### 4. 유저의 포인트 조회

* 유저의 현재 포인트가 몇 점인지 조회합니다.

### 5. 유저의 포인트 로그 조회

* 유저의 현재 포인트와 포인트가 적립된 이유를 확인할 수 있는 포인트로그가 함께 조회됩니다.
* 만약 리뷰가 삭제되었다면, 포인트 로그 내 리뷰 아이디는 null로 보입니다.

---

REMARKS
- [x] 포인트 증감이 있을 때마다 이력이 남아야 합니다. -> 포인트 로그에서 이력 확인이 가능합니다.
- [x] 사용자마다 현재 시점의 포인트 총점을 조회하거나 계산할 수 있어야 합니다. -> 사용자의 포인트 및 포인트 로그 조회가 가능합니다.
- [ ] 포인트 부여 API 구현에 필요한 SQL 수행 시, 전체 테이블 스캔이 일어나지 않는 인덱스가 필요합니다. 
      -> 인덱스의 경우, SQL 생성 및 수정에서는 적합하지 않다고 인지하고 있습니다.
      리뷰로 인해 포인트가 발생하면, 유저의 point값이 변경되는데 이는 PK인 userId를 통해서 스캔이 되도록 구현하였습니다.
      또한, 포인트 로그를 조회할 경우 포인트 로그 내 userId를 인덱스로 설정하여 전체 테이블 스캔이 일어나지 않도록 구현하였습니다.

- [x] 리뷰를 작성했다가 삭제하면 해당 리뷰로 부여한 내용 점수와 보너스 점수는 회수합니다. 
- [x] 리뷰를 수정하면 수정한 내용에 맞는 내용 점수를 계산하여 점수를 부여하거나 회수합니다.
  - [x] 글만 작성한 리뷰에 사진을 추가하면 1점을 부여합니다.
  - [x] 글과 사진이 있는 리뷰에서 사진을 모두 삭제하면 1점을 회수합니다.
- [x] 사용자 입장에서 본 '첫 리뷰'일 때 보너스 점수를 부여합니다.
  - [x] 어떤 장소에 사용자 A가 리뷰를 남겼다가 삭제하고, 삭제된 이후 사용자 B가 리뷰를 남기면 사용자 B에게 보너스 점수를 부여합니다.
  - [x] 어떤 장소에 사용자 A가 리뷰를 남겼다가 삭제하는데, 삭제되기 이전 사용자 B가 리뷰를 남기면 사용자 B에게 보너스 점수를 부여하지 않습니다.




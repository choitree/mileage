# 트리플여행자 클럽 마일리지 서비스

## SPEC
* Spring Boot 2.7.1
* Java 11
* QueryDSL 1.0.10
* MySQL (버전)
* JPA

## 요구사항 
### 리뷰 작성을 할 경우, 리뷰 작성 이벤트가 POST / events 로 이루어지고, 리뷰가 저장된다.

```
{
"type": "REVIEW",
"action": "ADD", /* "MOD", "DELETE" */
"reviewId": "240a0658-dc5f-4878-9381-ebb7b2667772",
"content": "좋아요!",
"attachedPhotoIds": ["e4d1a64e-a531-46de-88d0-ff0ed70c0bb8", "afb0cef2-
851d-4a50-bb07-9cc15cbdc332"],
"userId": "3ede0ef2-92b7-4817-a5f3-0c575361f745",
"placeId": "2e4baf1c-5acb-4efb-a1af-eddada31b00f"
}
```
* type: 미리 정의된 string 타입으로, 리뷰 이벤트의 경우 "REVIEW"입니다. 확장성을 위해서 enum을 만들어서 사용했습니다.
* action: 리뷰 생성 이벤트의 경우 "ADD" , 수정 이벤트는 "MOD" , 삭제 이벤트는 "DELETE" 값을 가지고 있습니다.
* reviewId: UUID 포맷의 review id입니다. 어떤 리뷰에 대한 이벤트인지 가리키는 값입니다.
* content: 리뷰의 내용입니다.
* attachedPhotoIds: 리뷰에 첨부된 이미지들의 id 배열입니다. 포맷이 명시되있지는 않지만, UUID 타입으로 지정했습니다.
* userId: 리뷰의 작성자 id입니다. 포맷이 명시되있지는 않지만, UUID 타입으로 지정했습니다.
* placeId: 리뷰가 작성된 장소의 id입니다. 포맷이 명시되있지는 않지만, UUID 타입으로 지정했습니다.

---

### 1. 리뷰 작성

* 해당 액션이 ADD인지 검증합니다.
* 리뷰에 해당하는 유저가 존재하는지 확인합니다.
* 리뷰에 해당하는 장소가 존재하는지 확인합니다.
* 해당 이벤트가 리뷰인지에 대해서 검증합니다.
* 글 작성한 경우 1점 포인트를 받습니다.
* 사진 작성한 경우 1점 포인트를 받습니다.
* 글 또는 사진 중 1가지만 작성하더라도 저장이 가능하며, 둘 다 없는 경우에는 예외가 발생합니다.
* 해당 장소에 첫 번째로 작성한 리뷰의 경우, 1점 포인트를 받습니다. (저장 당시 시점에 장소에 해당하는 리뷰의 개수가 0개인 경우에 지급)
* 리뷰 작성 시, 리뷰에 해당하는 사진들은 photo 테이블에 별도 저장됩니다.
* 리뷰 작성 시, 포인트 지급에 대한 로그 테이블에 정보가 저장됩니다.
* 포인트 지급 테이블의 경우, 포인트 지급 시기와 지급된 이유, 지급된 포인트를 간단하게 확인할 수 있습니다.
* 리뷰 작성 시, 유저의 포인트 필드에도 포인트가 반영되서 업데이트됩니다.


### 2. 리뷰 수정

* 리뷰 수정 시, 해당 액션이 MOD인지 검증합니다.
* 리뷰 수정하려는 리뷰 아이디에 해당하는 리뷰가 존재하는지 검증합니다.
* 리뷰 수정 전에 글의 여부와 수정 후 글의 여부를 비교해서 점수를 지급하거나 차감합니다.
* 리뷰 수정 전의 사진의 존재 여부와 수정 후 사진의 존재 여부를 비교해서 점수를 지급하거나 차감합니다.
* 리뷰를 수정하면서, 글과 사진을 모두 입력하지 않은 상태로 저장하려는 경우 예외가 발생합니다.
* 리뷰 수정 전의 리뷰에 해당하는 모든 사진을 삭제하고, 수정 후 리뷰에 해당하는 모든 사진을 저장합니다.
* 리뷰 수정 시, 리뷰 수정으로 인해 발생/차감된 포인트를 포인트 로그 테이블에 저장합니다.(차감된 경우 음수로 저장합니다.)
* 포인트 로그 테이블의 경우, 포인트 지급 시기와 지급된 이유, 지급된 포인트를 간단하게 확인할 수 있습니다.
* 리뷰 수정 시, 유저의 포인트 필드에도 변경된 포인트가 반영되서 업데이트됩니다.

### 3. 리뷰 삭제

* 리뷰 삭제 시, 해당 액션이 DELETE인지 검증합니다.
* 삭제하려는 리뷰 아이디에 해당하는 리뷰가 존재하는지 검증합니다.
* 해당 리뷰에 해당하는 모든 사진을 삭제합니다.
* 해당 리뷰로 발생한 포인트를 계산해서 모두 회수하고, 유저 테이블에 저장합니다.
* 포인트 로그 테이블 내 외래키인 리뷰아이디를 모두 null로 변경합니다. (유저가 리뷰 지급에 대한 사실 확인 시 파악하기 위함입니다.)
* 리뷰를 삭제합니다.

---



